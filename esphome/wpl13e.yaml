#
#  Minimal Sensor Definitions
#  Only sensors actually used for calculations and inputs
#

#########################################
#   SELECT                              
#########################################
select:
  - platform: template
    name: "PROGRAMMSCHALTER_SET"
    id: PROGRAMMSCHALTER_SET
    internal: true
    options:
      - "Notbetrieb"
      - "Bereitschaft"
      - "Automatik"
      - "Tagbetrieb"
      - "Absenkbetrieb"
      - "Warmwasser"
      - "Unbekannt"
    initial_option: "Unbekannt"
    optimistic: true
    on_value:
      then:
        - lambda: |-
            const std::string& option = id(PROGRAMMSCHALTER_SET).current_option();
            if (option != "Unbekannt") {
              const char* auswahl = option.c_str();
              writeSignal(&CanMembers[cm_manager], "PROGRAMMSCHALTER", auswahl);
              readSignal(&CanMembers[cm_manager], "PROGRAMMSCHALTER");
            }

#########################################
#   SENSORS                             
#########################################
sensor:
  # Required for COP calculations
  - platform: template
    name: "EL_AUFNAHMELEISTUNG_HEIZ_SUM"
    id: EL_AUFNAHMELEISTUNG_HEIZ_SUM
    internal: true
    unit_of_measurement: MWh
    device_class: energy
    accuracy_decimals: 3
    state_class: "total_increasing"

  - platform: template
    name: "EL_AUFNAHMELEISTUNG_WW_SUM"
    id: EL_AUFNAHMELEISTUNG_WW_SUM
    internal: true
    unit_of_measurement: MWh
    device_class: energy
    accuracy_decimals: 3
    state_class: "total_increasing"

  - platform: template
    name: "WAERMEERTRAG_2WE_HEIZ_SUM"
    id: WAERMEERTRAG_2WE_HEIZ_SUM
    internal: true
    unit_of_measurement: MWh
    device_class: energy
    accuracy_decimals: 3
    state_class: "total_increasing"

  - platform: template
    name: "WAERMEERTRAG_2WE_WW_SUM"
    id: WAERMEERTRAG_2WE_WW_SUM
    internal: true
    unit_of_measurement: MWh
    device_class: energy
    accuracy_decimals: 3
    state_class: "total_increasing"

  - platform: template
    name: "WAERMEERTRAG_HEIZ_SUM"
    id: WAERMEERTRAG_HEIZ_SUM
    internal: true
    unit_of_measurement: MWh
    device_class: energy
    accuracy_decimals: 3
    state_class: "total_increasing"

  - platform: template
    name: "WAERMEERTRAG_WW_SUM"
    id: WAERMEERTRAG_WW_SUM
    internal: true
    unit_of_measurement: MWh
    device_class: energy
    accuracy_decimals: 3
    state_class: "total_increasing"

  # Required for date/time formatting
  - platform: template
    name: "JAHR"
    id: JAHR
    internal: true
    accuracy_decimals: 0

  - platform: template
    name: "MONAT"
    id: MONAT
    internal: true
    accuracy_decimals: 0

  - platform: template
    name: "TAG"
    id: TAG
    internal: true
    accuracy_decimals: 0

  - platform: template
    name: "STUNDE"
    id: STUNDE
    internal: true
    accuracy_decimals: 0

  - platform: template
    name: "MINUTE"
    id: MINUTE
    internal: true
    accuracy_decimals: 0

  - platform: template
    name: "SEKUNDE"
    id: SEKUNDE
    internal: true
    accuracy_decimals: 0

  # Required for Home Assistant input helpers
  - platform: template
    name: "EINSTELL_SPEICHERSOLLTEMP"
    id: EINSTELL_SPEICHERSOLLTEMP
    internal: true
    unit_of_measurement: "째C"
    accuracy_decimals: 1

  - platform: template
    name: "EINSTELL_SPEICHERSOLLTEMP2"
    id: EINSTELL_SPEICHERSOLLTEMP2
    internal: true
    unit_of_measurement: "째C"
    accuracy_decimals: 1

  - platform: template
    name: "SPEICHERISTTEMP"
    id: SPEICHERISTTEMP
    internal: true
    unit_of_measurement: "째C"
    accuracy_decimals: 1
    filters:
      - offset: 3.9

  - platform: template
    name: "SPEICHERSOLLTEMP"
    id: SPEICHERSOLLTEMP
    internal: true
    unit_of_measurement: "째C"
    accuracy_decimals: 1

  # COP output sensors
  - platform: template
    name: "COP_WW"
    id: COP_WW
    internal: true
    device_class: "power_factor"
    accuracy_decimals: 2

  - platform: template
    name: "COP_HEIZ"
    id: COP_HEIZ
    internal: true
    device_class: "power_factor"
    accuracy_decimals: 2

  - platform: template
    name: "COP_GESAMT"
    id: COP_GESAMT
    internal: true
    device_class: "power_factor"
    accuracy_decimals: 2

#########################################
#   TEXT SENSOREN                       
#########################################
text_sensor:
  # Home Assistant input helpers
  - platform: homeassistant
    name: "EINSTELL_SPEICHERSOLLTEMP_SET"
    id: EINSTELL_SPEICHERSOLLTEMP_SET
    entity_id: input_number.speichersolltemp_set
    on_value:
      then:
        lambda: |-
          if(atoi(x.c_str()) != 20) {
            char temp[3];
            strncpy(temp, x.c_str(), sizeof(temp)-1);
            temp[2] ='\0';
            const char* ctemp = temp;
            writeSignal(&CanMembers[cm_manager], "EINSTELL_SPEICHERSOLLTEMP", ctemp);
            id(EINSTELL_SPEICHERSOLLTEMP).update();
            id(SPEICHERISTTEMP).update();
            id(SPEICHERSOLLTEMP).update();
          }
          return;

  - platform: homeassistant
    name: "EINSTELL_SPEICHERSOLLTEMP2_SET"
    id: EINSTELL_SPEICHERSOLLTEMP2_SET
    entity_id: input_number.speichersolltemp2_set
    on_value:
      then:
        lambda: |-
          if(atoi(x.c_str()) != 20) {
            char temp[3];
            strncpy(temp, x.c_str(), sizeof(temp)-1);
            temp[2] ='\0';
            const char* ctemp = temp;
            writeSignal(&CanMembers[cm_manager], "EINSTELL_SPEICHERSOLLTEMP2", ctemp);
            id(EINSTELL_SPEICHERSOLLTEMP2).update();
            id(SPEICHERISTTEMP).update();
            id(SPEICHERSOLLTEMP).update();
          }
          return;

  # Text sensors with lambdas
  - platform: template
    name: "PROGRAMMSCHALTER"
    id: PROGRAMMSCHALTER
    internal: true
    lambda: |-
      readSignal(&CanMembers[cm_manager], "PROGRAMMSCHALTER");
      return {};

  - platform: template
    name: "SOMMERBETRIEB"
    id: SOMMERBETRIEB
    internal: true
    lambda: |-
      readSignal(&CanMembers[cm_manager], "SOMMERBETRIEB");
      return {};

  - platform: template
    name: "WW_ECO"
    id: WW_ECO
    internal: true
    lambda: |-
      readSignal(&CanMembers[cm_manager], "WW_ECO");
      return {};
