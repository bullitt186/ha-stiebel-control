#
#
#  Copyright (C) 2023 Bastian Stahmer (bastian@stahmer.net)
#
#  This program is part of the ESPHome / Home Assistant Program "ha-stiebel-control"
#  and is free software: you can redistribute it and/or modify
#  it under the terms of the GNU Lesser General Public License as published by
#  the Free Software Foundation version 3 of the License.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
#  GNU Lesser General Public License for more details.
#
#  You should have received a copy of the GNU Lesser General Public License
#  along with this program. If not, see http://www.gnu.org/licenses/ .
#

esphome:
  name: heatingpump
  friendly_name: "Heating Pump CAN Interface"
  includes:
    - ha-stiebel-control/elster/ElsterTable.h
    - ha-stiebel-control/elster/KElsterTable.h
    - ha-stiebel-control/elster/KElsterTable.cpp
    - ha-stiebel-control/elster/NUtils.h
    - ha-stiebel-control/elster/NUtils.cpp
    - ha-stiebel-control/elster/NTypes.h
    - ha-stiebel-control/ha-stiebel-control.h

esp32:
  board: esp32dev
  framework:
    type: arduino

#########################################
#                                       #
#   TEXT SENSOREN                       #
#                                       #
#########################################
text_sensor:
  #########################################
  #                                       #
  #   HOME ASSISTANT TEXT SENSOREN        #
  #                                       #
  #########################################
  - platform: homeassistant
    name: "Wärmepumpe Datum Setpoint"
    id: warmepumpe_datum
    entity_id: input_datetime.warmepumpe_datum

  - platform: homeassistant
    name: "Wärmepumpe Uhrzeit Setpoint"
    id: warmepumpe_uhrzeit
    entity_id: input_datetime.warmepumpe_uhrzeit

  #########################################
  #                                       #
  #   BERECHNETE TEXT SENSORS             #
  #                                       #
  #########################################
  - platform: template
    name: "DATUM"
    id: DATUM
    icon: "mdi:calendar"

  - platform: template
    name: "ZEIT"
    id: ZEIT
    icon: "mdi:clock"

#########################################
#                                       #
#   BUTTON                              #
#                                       #
#########################################
button:
  - platform: template
    name: "Update Uhrzeit"
    id: update_uhrzeit
    on_press:
      then:
        lambda: |-
          updateTime(CanMembers[cm_manager], id(warmepumpe_uhrzeit).state.c_str());

  - platform: template
    name: "Update Datum"
    id: update_datum
    on_press:
      then:
        lambda: |-
          updateDate(CanMembers[cm_manager], id(warmepumpe_datum).state.c_str());

  - platform: template
    name: "Identify CAN Members"
    id: identify_can_members
    on_press:
      then:
        lambda: |-
          identifyCanMembers();
          return;

#########################################
#                                       #
#   SPI Konfiguration                   #
#                                       #
#########################################
spi:
  id: McpSpi
  clk_pin: ${can_clk_pin}
  mosi_pin: ${can_mosi_pin}
  miso_pin: ${can_miso_pin}

#########################################
#                                       #
#   canbus Konfiguration                #
#                                       #
#########################################
canbus:
  - platform: mcp2515
    id: my_mcp2515
    spi_id: McpSpi
    cs_pin: ${can_cs_pin}
    can_id: ${can_id_pc}
    use_extended_id: false
    bit_rate: 20kbps
    on_frame:
      - can_id: 0
        can_id_mask: 0
        then:
          - lambda: |-
              processAndUpdate(can_id, x);
