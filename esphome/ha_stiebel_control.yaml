template:
  - sensor:
      - name: "Programmschalter with Icon"
        unique_id: 3408aa8e-7afb-4170-9ab1-90cab772e78e
        state: "{{ states('sensor.heatingpump_programmschalter') }}"
        icon: >-
          {% if is_state('sensor.heatingpump_programmschalter', 'Notbetrieb') %}
            mdi:power-off
          {% elif is_state('sensor.heatingpump_programmschalter', 'Bereitschaft') %}
            mdi:flash
          {% elif is_state('sensor.heatingpump_programmschalter', 'Automatik') %}
            mdi:weather-sunny
          {% elif is_state('sensor.heatingpump_programmschalter', 'Tagbetrieb') %}
            mdi:white-balance-sunny
          {% elif is_state('sensor.heatingpump_programmschalter', 'Absenkbetrieb') %}
            mdi:thermometer-chevron-down
          {% elif is_state('sensor.heatingpump_programmschalter', 'Warmwasser') %}
            mdi:water
          {% else %}
            mdi:help-circle
          {% endif %}

      - name: "Betriebsart"
        unique_id: 0c0078f8-8347-4b47-8bff-8510815b71f3
        state: >-
          {% if is_state('sensor.heatingpump_sommerbetrieb', 'on') %}
            Sommerbetrieb
          {% else %}
            Normalbetrieb
          {% endif %}
        icon: >-
          {% if is_state('sensor.heatingpump_sommerbetrieb', 'on') %}
            mdi:white-balance-sunny
          {% else %}
            mdi:circle-outline
          {% endif %}

      - name: "Delta T WP (kontinuierlich)"
        unique_id: heatingpump_delta_t_wp_continuous
        unit_of_measurement: "K"
        state_class: measurement
        device_class: temperature
        icon: mdi:thermometer
        state: >
          {% set vl = states('sensor.heatingpump_wpvorlaufist_heizmodul') | float(none) %}
          {% set rl = states('sensor.heatingpump_ruecklaufisttemp_heizmodul') | float(none) %}
          {% if vl is not none and rl is not none and vl > -50 and rl > -50 %}
            {{ (vl - rl) | round(2) }}
          {% else %}
            unknown
          {% endif %}
        availability: >
          {{ states('sensor.heatingpump_wpvorlaufist_heizmodul') not in ['unknown','unavailable','none'] and states('sensor.heatingpump_ruecklaufisttemp_heizmodul') not in ['unknown','unavailable','none'] }}

      - name: "Delta T WP (nur bei Verdichter an)"
        unique_id: heatingpump_delta_t_wp_only_running
        unit_of_measurement: "K"
        state_class: measurement
        device_class: temperature
        icon: mdi:thermometer-chevron-up
        state: >
          {% if is_state('binary_sensor.heatingpump_compressor_active', 'on') %}
            {% set vl = states('sensor.heatingpump_wpvorlaufist_heizmodul') | float(none) %}
            {% set rl = states('sensor.heatingpump_ruecklaufisttemp_heizmodul') | float(none) %}
            {% if vl is not none and rl is not none and vl > -50 and rl > -50 %}
              {{ (vl - rl) | round(2) }}
            {% else %}
              unknown
            {% endif %}
          {% else %}
            unknown
          {% endif %}
        availability: >
          {{ is_state('binary_sensor.heatingpump_compressor_active', 'on') or is_state('binary_sensor.heatingpump_compressor_active', 'off') }}

  - binary_sensor:
      - name: "WP Verdichter aktiv"
        unique_id: heatingpump_compressor_active
        device_class: running
        icon: >
          {% if is_state('binary_sensor.wp_verdichter_aktiv', 'on') %}
            mdi:engine
          {% else %}
            mdi:engine-off
          {% endif %}
        state: >
          {{ is_state('sensor.heatingpump_verdichter', 'on') or (states('sensor.heatingpump_verdichter') | float(0)) > 2 }}
        availability: >
          {{ states('sensor.heatingpump_verdichter') not in ['unknown','unavailable','none'] }}

input_number:
  speichersolltemp2_set:
    name: "SPEICHERSOLLTEMP2_SET"
    initial: 20
    min: 20
    max: 60
    mode: box
    step: 1
    unit_of_measurement: "°C"
    icon: mdi:thermometer-low

  speichersolltemp_set:
    name: "SPEICHERSOLLTEMP_SET"
    initial: 20
    min: 20
    max: 60
    mode: box
    step: 1
    unit_of_measurement: "°C"
    icon: mdi:thermometer-high

sensor:
  - platform: statistics
    name: "Delta T WP (5min Mittel)"
    entity_id: sensor.delta_t_wp_kontinuierlich
    state_characteristic: mean
    max_age:
      minutes: 5
